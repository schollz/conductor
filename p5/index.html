<html>

<head>
    <script src="/static/p5.js"></script>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            /* Ensure no scrollbars appear */
        }
    </style>
</head>

<body>

    <script>
        var socket;
        let windata = Array.from({ length: 128 }, () => [0, 0]); // Initialize array
        let height, width, radius;
        const socketMessageListener = (e) => {
            let data = JSON.parse(e.data);
            if (data.loop != undefined) {
                const loopid = data.loop;
                const x = Math.min(Math.max(data.x, -1), 1); // Clipping to -1 to 1
                const y = Math.min(Math.max(data.y, -1), 1);
                windata[loopid] = [x, y]; // Update windata
                // console.log(data.loop, data.x, data.y);
            }
        };
        const socketOpenListener = (e) => {
            console.log('Connected');
            socket.send(JSON.stringify({ message: "hello, server" }))
        };
        const socketErrorListener = (e) => {
            console.error(e);
        }
        const socketCloseListener = (e) => {
            if (socket) {
                console.log('Disconnected.');
            }
            var url = window.origin.replace("http", "ws") + '/ws';
            socket = new WebSocket(url);
            socket.onopen = socketOpenListener;
            socket.onmessage = socketMessageListener;
            socket.onclose = socketCloseListener;
            socket.onerror = socketErrorListener;
        };
        window.addEventListener('load', (event) => {
            socketCloseListener();
        });


        function setup() {
            width = windowWidth;
            height = windowHeight;
            radius = height / 10; // Update radius based on new height
            createCanvas(width, height);
            strokeWeight(4);
            frameRate(30);
        }

        function invertColor(hex) {
            return (Number(`0x1${hex}`) ^ 0xFFFFFF).toString(16).substr(1).toUpperCase()
        }
        function draw() {
            blendMode(BLEND);
            background('#fbf8cc'); // Using a color similar to #FFFAD7
            blendMode(EXCLUSION);

            const colors = [
                invertColor("ffcfd2"),
                invertColor("f1c0e8"),
                invertColor("cfbaf0"),
                invertColor("a3c4f3"),
                invertColor("90dbf4"),
                invertColor("90dbf4"),
                invertColor("8eecf5"),
            ]
            windata.forEach(([x, y], index) => {
                if (x !== 0 || y !== 0) { // Check if data is not the initialized value
                    let mappedX = ((x + 1) / 2) * (width - 3 * radius) + 2 * radius; // Map from -1 to 1 into 0 to width
                    let mappedY = ((y + 1) / 2) * (height - 3 * radius) + 2 * radius; // Map from -1 to 1 into 0 to height
                    fill('#' + colors[index % colors.length]);

                    // Begin drawing a sketchy circle using Perlin noise
                    beginShape();
                    for (let angle = 0; angle < TWO_PI; angle += 0.1) {
                        let offset = map(noise(cos(angle) * 0.5 + 1, sin(angle) * 0.5 + 1, frameCount * 0.005 + index), 0, 1, -50, 50);
                        let noisyRadius = radius + offset + noise(frameCount / 30 * 0.01 + index) * 100;
                        let x = mappedX + cos(angle) * noisyRadius;
                        let y = mappedY + sin(angle) * noisyRadius;
                        vertex(x, y);
                    }
                    endShape(CLOSE);
                }
            });


            {
                let index = 10;
                breathScale = 1 + 400 * sin(frameCount / 30 / 4);
                let mappedX = ((0 + 1) / 2) * (width); // Map from -1 to 1 into 0 to width
                let mappedY = ((0 + 1) / 2) * (height); // Map from -1 to 1 into 0 to height
                fill('#' + colors[index % colors.length]);
                // Begin drawing a sketchy circle using Perlin noise
                beginShape();
                for (let angle = 0; angle < TWO_PI; angle += 0.1) {
                    let offset = map(noise(cos(angle) * 0.5 + 1, sin(angle) * 0.5 + 1, frameCount * 0.005 + index), 0, 1, -50, 50);
                    let noisyRadius = breathScale + offset + noise(frameCount / 30 * 0.01 + index) * 100;
                    let x = mappedX + cos(angle) * noisyRadius;
                    let y = mappedY + sin(angle) * noisyRadius;
                    vertex(x, y);
                }
                endShape(CLOSE);
            }


            blendMode(BLEND);
            // no fill
            stroke(0);
            strokeWeight(4);
            noFill();

            windata.forEach(([x, y], index) => {
                if (x !== 0 || y !== 0) { // Check if data is not the initialized value
                    let mappedX = ((x + 1) / 2) * (width - 3 * radius) + 2 * radius; // Map from -1 to 1 into 0 to width
                    let mappedY = ((y + 1) / 2) * (height - 3 * radius) + 2 * radius; // Map from -1 to 1 into 0 to height

                    // Begin drawing a sketchy circle using Perlin noise
                    beginShape();
                    for (let angle = 0; angle < TWO_PI; angle += 0.1) {
                        let offset = map(noise(cos(angle) * 0.4 + 1, sin(angle) * 0.4 + 1, frameCount * 0.006 + index), 0, 1, -50, 50);
                        let noisyRadius = radius + offset + noise(frameCount / 30 * 0.01 + index) * 100;
                        let x = mappedX + cos(angle) * noisyRadius;
                        let y = mappedY + sin(angle) * noisyRadius;
                        vertex(x, y);
                    }
                    endShape(CLOSE);
                }
            });



            {

                let index = 11;
                breathScale = 1 + 400 * sin(frameCount / 30 / 4);
                let mappedX = ((0 + 1) / 2) * (width); // Map from -1 to 1 into 0 to width
                let mappedY = ((0 + 1) / 2) * (height); // Map from -1 to 1 into 0 to height
                // Begin drawing a sketchy circle using Perlin noise
                beginShape();
                for (let angle = 0; angle < TWO_PI; angle += 0.1) {
                    let offset = map(noise(cos(angle) * 0.5 + 1, sin(angle) * 0.5 + 1, frameCount * 0.005 + index), 0, 1, -50, 50);
                    let noisyRadius = breathScale + offset + noise(frameCount / 30 * 0.01 + index) * 100;
                    let x = mappedX + cos(angle) * noisyRadius;
                    let y = mappedY + sin(angle) * noisyRadius;
                    vertex(x, y);
                }
                endShape(CLOSE);
            }

        }

        // Resize the canvas when the window is resized
        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
            width = windowWidth;
            height = windowHeight;
            radius = height / 10; // Update radius based on new height
        }
    </script>
</body>

</html>